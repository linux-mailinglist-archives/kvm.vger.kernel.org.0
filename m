Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id D458A41D794
	for <lists+kvm@lfdr.de>; Thu, 30 Sep 2021 12:23:06 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1349839AbhI3KYp (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Thu, 30 Sep 2021 06:24:45 -0400
Received: from mail.kernel.org ([198.145.29.99]:39528 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1349764AbhI3KYn (ORCPT <rfc822;kvm@vger.kernel.org>);
        Thu, 30 Sep 2021 06:24:43 -0400
Received: from disco-boy.misterjones.org (disco-boy.misterjones.org [51.254.78.96])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by mail.kernel.org (Postfix) with ESMTPSA id 4821661881;
        Thu, 30 Sep 2021 10:23:01 +0000 (UTC)
Received: from sofa.misterjones.org ([185.219.108.64] helo=why.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1mVtDP-00DxDc-3r; Thu, 30 Sep 2021 11:22:59 +0100
Date:   Thu, 30 Sep 2021 11:22:58 +0100
Message-ID: <87bl4atla5.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     David Brazdil <dbrazdil@google.com>
Cc:     linux-arm-kernel@lists.infradead.org, kvm@vger.kernel.org,
        kvmarm@lists.cs.columbia.edu, ascull@google.com,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Alexandru Elisei <alexandru.elisei@arm.com>,
        kernel-team@android.com
Subject: Re: [PATCH] KVM: arm64: Allow KVM to be disabled from the command line
In-Reply-To: <YVMtgBw+qG713+4k@google.com>
References: <20210903091652.985836-1-maz@kernel.org>
        <YVMtgBw+qG713+4k@google.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: dbrazdil@google.com, linux-arm-kernel@lists.infradead.org, kvm@vger.kernel.org, kvmarm@lists.cs.columbia.edu, ascull@google.com, james.morse@arm.com, suzuki.poulose@arm.com, alexandru.elisei@arm.com, kernel-team@android.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Hi David,

On Tue, 28 Sep 2021 15:58:08 +0100,
David Brazdil <dbrazdil@google.com> wrote:
> 
> Hey Marc,
> that all makes sense:
> 
> Reviewed-by: David Brazdil <dbrazdil@google.com>
> 
> > @@ -2137,8 +2142,15 @@ static int __init early_kvm_mode_cfg(char *arg)
> >  		return 0;
> >  	}
> >  
> > -	if (strcmp(arg, "nvhe") == 0 && !WARN_ON(is_kernel_in_hyp_mode()))
> > +	if (strcmp(arg, "nvhe") == 0 && !WARN_ON(is_kernel_in_hyp_mode())) {
> > +		kvm_mode = KVM_MODE_DEFAULT;
> >  		return 0;
> > +	}
> > +
> > +	if (strcmp(arg, "none") == 0 && !WARN_ON(is_kernel_in_hyp_mode())) {
> nit: I noticed we check is_kernel_in_hyp_mode here for nvhe/none but for
> protected it is checked in is_kvm_protected_mode. May be worth unifying?

is_kvm_protected_mode() drives a capability (as we rely on the
associated static key), and we don't need this with either 'nvhe' nor
'none'.

So I'm unsure what we can unify, to be honest. Can you suggest a
patch?

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.
