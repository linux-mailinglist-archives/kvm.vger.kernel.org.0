Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 443AE544396
	for <lists+kvm@lfdr.de>; Thu,  9 Jun 2022 08:10:38 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S238718AbiFIGKg (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Thu, 9 Jun 2022 02:10:36 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:55268 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231339AbiFIGKe (ORCPT <rfc822;kvm@vger.kernel.org>);
        Thu, 9 Jun 2022 02:10:34 -0400
Received: from mail-oi1-x233.google.com (mail-oi1-x233.google.com [IPv6:2607:f8b0:4864:20::233])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B33EE39B88
        for <kvm@vger.kernel.org>; Wed,  8 Jun 2022 23:10:31 -0700 (PDT)
Received: by mail-oi1-x233.google.com with SMTP id h187so17639599oif.4
        for <kvm@vger.kernel.org>; Wed, 08 Jun 2022 23:10:31 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20210112;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=NdHR2NIjbUP78PFYeyIgFS7y+RZOhrjzozxhM3S1oaY=;
        b=Q6TcKRsb6QCacT1EloeSMw+QV8ThhugDK6lXavablrtGoy/D+ItGZNTGRCXrMI65fW
         9xglhOhXk8oZyXXmztAW/HwS1dCaBUBqNJvQmZYPudVkwpBEukJiMTGstre1ho17QVQC
         yCHeBmBr2e6DbmSPxKKJ5l7YDx4M315jPRtCbqjTqksSHpmH3LZFcIKC/W/TxnyDkz84
         3JOCl1tplNBLTJqO7akACXx1yI4zM0VAwx2mnR19pCzMevGvesP6urjnOUx9D4P4vQ0+
         mJYUD31fDD6pvBKlPgMGWGTf91s7VFTZhESNpJ3UYVCv6U/qBG9C0Vn27oIHYgueH4+Z
         fM+g==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=NdHR2NIjbUP78PFYeyIgFS7y+RZOhrjzozxhM3S1oaY=;
        b=Er15uSh0F4e6HBzPfHPEjQH9OkGn87xXjUjs6n+ves04LQjmyoSLLf1vTD6j+h8bfB
         8r7a0e2S2PlDR7dhQcxuVrOUwRuBf1AHH4APi1WonxL2O0VKc3XQhYkOX1BqbfTvA424
         sPAPbGA7UcKuGspWIaRgt5jWJPnguRzFzDMCDday29FgY4BmV6CvNbnsM5HZp5fdNc5u
         JEHQsJc5V8NrFjwgjUuSbYUGRSDeWarf0Gs31hfclhW63dyEuJU7LUy3XWtqYpAicfd9
         kyQMixzr6at/W+z0C9zjLJ+dZZhvdNx2gL5fXzNevQDkT1cWIW6S+YJCTFWVKqWTm48e
         NDXg==
X-Gm-Message-State: AOAM531EovoQYI4kLaE0iUTg1HOqa5SteDx8gZsVaOLlzTWSiFBXgzAf
        SLeNmaEYHDLuApqDt1AedCtVbupB+6evSZAi/REYyg==
X-Google-Smtp-Source: ABdhPJySBCo7XChZly1cnDd33GTRmnk064t0lYsGNiwe9fWhmKZvx39GjcsC8z6DIWzlxBRQ0UP6jFPW8g/Vh/fwQ+g=
X-Received: by 2002:a05:6808:3198:b0:32b:a54:1238 with SMTP id
 cd24-20020a056808319800b0032b0a541238mr808316oib.16.1654755030894; Wed, 08
 Jun 2022 23:10:30 -0700 (PDT)
MIME-Version: 1.0
References: <20220528113829.1043361-1-maz@kernel.org> <20220528113829.1043361-7-maz@kernel.org>
In-Reply-To: <20220528113829.1043361-7-maz@kernel.org>
From:   Reiji Watanabe <reijiw@google.com>
Date:   Wed, 8 Jun 2022 23:10:14 -0700
Message-ID: <CAAeT=FzXWDfkR5ck0vpiRLKi0nU9e5Ua=yg=3Rj--Gq+aBaVUg@mail.gmail.com>
Subject: Re: [PATCH 06/18] KVM: arm64: Add three sets of flags to the vcpu state
To:     Marc Zyngier <maz@kernel.org>
Cc:     kvmarm@lists.cs.columbia.edu, kvm@vger.kernel.org,
        Linux ARM <linux-arm-kernel@lists.infradead.org>,
        kernel-team@android.com, Will Deacon <will@kernel.org>,
        Mark Brown <broonie@kernel.org>
Content-Type: text/plain; charset="UTF-8"
X-Spam-Status: No, score=-15.6 required=5.0 tests=BAYES_00,DKIMWL_WL_MED,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,
        ENV_AND_HDR_SPF_MATCH,RCVD_IN_DNSWL_NONE,SPF_HELO_NONE,SPF_PASS,
        T_SCC_BODY_TEXT_LINE,URIBL_BLOCKED,URI_DOTEDU,USER_IN_DEF_DKIM_WL,
        USER_IN_DEF_SPF_WL autolearn=no autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

Hi Marc,

On Sat, May 28, 2022 at 4:38 AM Marc Zyngier <maz@kernel.org> wrote:
>
> It so appears that each of the vcpu flags is really belonging to
> one of three categories:
>
> - a configuration flag, set once and for all
> - an input flag generated by the kernel for the hypervisor to use
> - a state flag that is only for the kernel's own bookkeeping
>
> As we are going to split all the existing flags into these three
> sets, introduce all three in one go.
>
> No functional change other than a bit of bloat...
>
> Signed-off-by: Marc Zyngier <maz@kernel.org>
> ---
>  arch/arm64/include/asm/kvm_host.h | 9 +++++++++
>  1 file changed, 9 insertions(+)
>
> diff --git a/arch/arm64/include/asm/kvm_host.h b/arch/arm64/include/asm/kvm_host.h
> index 5eb6791df608..c9dd0d4e22f2 100644
> --- a/arch/arm64/include/asm/kvm_host.h
> +++ b/arch/arm64/include/asm/kvm_host.h
> @@ -338,6 +338,15 @@ struct kvm_vcpu_arch {
>         /* Miscellaneous vcpu state flags */
>         u64 flags;
>
> +       /* Configuration flags */
> +       u64 cflags;
> +
> +       /* Input flags to the hypervisor code */
> +       u64 iflags;
> +
> +       /* State flags, unused by the hypervisor code */
> +       u64 sflags;

Although I think VCPU_SVE_FINALIZED could be considered "state" rather
than "configuration", I assume the reason why it is handled by cflags
in the following patches is because VCPU_SVE_FINALIZED is set once
for all. If my assumption is correct, it would be clearer to add
"set once and for all" in the comment for cflags.

Also, if we end up using VCPU_SVE_FINALIZED in hypervisor code later,
then should it be handled by iflags instead of cflags ?

My understanding of how those flags should be used is as follows.
Is my understanding correct ?

 iflags: flags that are used by hypervisor code
 cflags: flags that are set once for all and unused by hypervisor code
 sflags: flags that could be set/cleared more than once and unused
         by hypervisor code

Thanks,
Reiji

> +
>         /*
>          * We maintain more than a single set of debug registers to support
>          * debugging the guest from the host and to maintain separate host and
> --
> 2.34.1
>
> _______________________________________________
> kvmarm mailing list
> kvmarm@lists.cs.columbia.edu
> https://lists.cs.columbia.edu/mailman/listinfo/kvmarm
