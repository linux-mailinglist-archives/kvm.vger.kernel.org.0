Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id A032A6CCA87
	for <lists+kvm@lfdr.de>; Tue, 28 Mar 2023 21:22:22 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229870AbjC1TWV (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Tue, 28 Mar 2023 15:22:21 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40594 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229617AbjC1TWU (ORCPT <rfc822;kvm@vger.kernel.org>);
        Tue, 28 Mar 2023 15:22:20 -0400
Received: from ams.source.kernel.org (ams.source.kernel.org [IPv6:2604:1380:4601:e00::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6DF413586
        for <kvm@vger.kernel.org>; Tue, 28 Mar 2023 12:22:19 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by ams.source.kernel.org (Postfix) with ESMTPS id 1D5ADB81E3A
        for <kvm@vger.kernel.org>; Tue, 28 Mar 2023 19:22:18 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id A2896C433EF;
        Tue, 28 Mar 2023 19:22:16 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1680031336;
        bh=SdUXX1XZF8JxcW5RB4HlvxCisNkczpZsVbh7glZ9bpo=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=sOFxorl0CO5XLg/s6ZsFZjbFyQMnjsUlw8F5j4iFju9IPCunmRPFffE4CvNKpA7Mg
         ThRVIyrGf5Q4uilyfzg/QYkY44BXSqU2uVLO77PoyQOwkalVY2cbU3qlOw27pi2gl/
         1cv2vrBmvbDn6SeX0AwNlPHAp/EZVFrvqFZnaWTjtni5FEDKQ6x49mHmTIRHm4t6za
         qBZ4xmlZmd85ehmAbs8tVvG8VfuWhPqiz9BN28PStejc5eZg7X7vClfGU7yetdCNFl
         aiwgDXxfTa5f2d5NlP5VtbgBfilnuF98k8rtTb2QEtgPF7s0qbSnP8qjwEMPSxKpaL
         szjuY5Y+GsIwA==
Received: from sofa.misterjones.org ([185.219.108.64] helo=wait-a-minute.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.95)
        (envelope-from <maz@kernel.org>)
        id 1phEta-003rPf-AZ;
        Tue, 28 Mar 2023 20:22:14 +0100
Date:   Tue, 28 Mar 2023 20:22:09 +0100
Message-ID: <87y1ngr89q.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Jing Zhang <jingzhangos@google.com>
Cc:     KVM <kvm@vger.kernel.org>, KVMARM <kvmarm@lists.linux.dev>,
        ARMLinux <linux-arm-kernel@lists.infradead.org>,
        Oliver Upton <oupton@google.com>,
        Will Deacon <will@kernel.org>,
        Paolo Bonzini <pbonzini@redhat.com>,
        James Morse <james.morse@arm.com>,
        Alexandru Elisei <alexandru.elisei@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Fuad Tabba <tabba@google.com>,
        Reiji Watanabe <reijiw@google.com>,
        Ricardo Koller <ricarkol@google.com>,
        Raghavendra Rao Ananta <rananta@google.com>
Subject: Re: [PATCH v4 2/6] KVM: arm64: Save ID registers' sanitized value per guest
In-Reply-To: <CAAdAUtjp1tdyadjtU0RrdsRq-D3518G8eqP_coYNJ1vFEvrz2Q@mail.gmail.com>
References: <20230317050637.766317-1-jingzhangos@google.com>
        <20230317050637.766317-3-jingzhangos@google.com>
        <861qlaxzyw.wl-maz@kernel.org>
        <CAAdAUtjp1tdyadjtU0RrdsRq-D3518G8eqP_coYNJ1vFEvrz2Q@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: jingzhangos@google.com, kvm@vger.kernel.org, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, oupton@google.com, will@kernel.org, pbonzini@redhat.com, james.morse@arm.com, alexandru.elisei@arm.com, suzuki.poulose@arm.com, tabba@google.com, reijiw@google.com, ricarkol@google.com, rananta@google.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-2.5 required=5.0 tests=DKIMWL_WL_HIGH,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_MED,SPF_HELO_NONE,
        SPF_PASS autolearn=unavailable autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Tue, 28 Mar 2023 18:36:58 +0100,
Jing Zhang <jingzhangos@google.com> wrote:
> 
> Hi Marc,

[...]

> IIUC, usually we don't need a specific locking to update idregs here.
> All idregs are 64 bit and can be read/written atomically. The only
> case that may need a locking is to keep the consistency for PMUVer in
> AA64DFR0_EL1 and PerfMon in DFR0_EL1. If there is no use case for two
> VCPU threads in a VM to update PMUVer and PerfMon concurrently, then
> we don't need the locking as in later patch by using the kvm lock.
> WDTY?

I think we generally need locking for any writable id-reg, the goal
being that they will ultimately *all* be writable. As you found out,
there is this need for the PMU fields, and I'm willing to bet that
there will be more of those.

And given that the locking you have used in some of the later patches
violates the locking order (don't worry, you're not alone!), we need
to use something else. Which is where Oliver's series comes into play.

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.
