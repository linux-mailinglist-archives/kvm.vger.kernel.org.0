Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 3C661707D19
	for <lists+kvm@lfdr.de>; Thu, 18 May 2023 11:42:41 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230160AbjERJmj (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Thu, 18 May 2023 05:42:39 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59802 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230033AbjERJmi (ORCPT <rfc822;kvm@vger.kernel.org>);
        Thu, 18 May 2023 05:42:38 -0400
Received: from dfw.source.kernel.org (dfw.source.kernel.org [139.178.84.217])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 2F85C198A
        for <kvm@vger.kernel.org>; Thu, 18 May 2023 02:42:37 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id C0FD264B77
        for <kvm@vger.kernel.org>; Thu, 18 May 2023 09:42:36 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 2487EC433EF;
        Thu, 18 May 2023 09:42:36 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1684402956;
        bh=uisIdhnWB6GwRAUzV3HPPcigaCgjrHYq2RgDUEI1zEw=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=C73U7N45qEWfraWndjG8oBmtR0eYkY7+IGrOqxqrYZoVxsyV9W4A/56KoPyJT5t3U
         8xXruXpFilLkLAyUjQUg2od30+lCu5u6IAPx0VuzTS0ZZ2ULd6nPC5JVnY+AIZIBmA
         aj+2prrvvaU7Mz5Ycf45LKyXgmhIZkUZ9o0QnIZMglWzJ3QZH/xForB2VO1TLC675L
         SIsYELItvebLfS3KuWA3hB7h7Ku2BasAfd5L+8exdMAPwAPmpN6b3cPkuUNA3Tb5lB
         4+9tL4Cq8UDaae0Pt/eTmCpyLMO4yCZ0Nv7PxaL376Nb8g9wJ6UCLk+oL5NnbDCFrD
         EznANNNxwGx2w==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.95)
        (envelope-from <maz@kernel.org>)
        id 1pza9Z-00G6Do-TM;
        Thu, 18 May 2023 10:42:34 +0100
Date:   Thu, 18 May 2023 10:42:33 +0100
Message-ID: <86fs7ukmba.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Salil Mehta <salil.mehta@huawei.com>
Cc:     Oliver Upton <oliver.upton@linux.dev>,
        "kvmarm@lists.linux.dev" <kvmarm@lists.linux.dev>,
        "kvm@vger.kernel.org" <kvm@vger.kernel.org>,
        Paolo Bonzini <pbonzini@redhat.com>,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        yuzenghui <yuzenghui@huawei.com>,
        Sean Christopherson <seanjc@google.com>
Subject: Re: [PATCH v3 08/13] KVM: arm64: Add support for KVM_EXIT_HYPERCALL
In-Reply-To: <30eae0208b55463bb644c6700951d4b8@huawei.com>
References: <20230404154050.2270077-1-oliver.upton@linux.dev>
        <20230404154050.2270077-9-oliver.upton@linux.dev>
        <87o7o26aty.wl-maz@kernel.org>
        <86pm8iv8tj.wl-maz@kernel.org>
        <fd9aee7022ea47e29cbff3120764c2c6@huawei.com>
        <ZGUfFn0jai9n4eSF@linux.dev>
        <86ilcqkqrf.wl-maz@kernel.org>
        <30eae0208b55463bb644c6700951d4b8@huawei.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/28.2
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: salil.mehta@huawei.com, oliver.upton@linux.dev, kvmarm@lists.linux.dev, kvm@vger.kernel.org, pbonzini@redhat.com, james.morse@arm.com, suzuki.poulose@arm.com, yuzenghui@huawei.com, seanjc@google.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-7.1 required=5.0 tests=BAYES_00,DKIMWL_WL_HIGH,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,
        SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Thu, 18 May 2023 10:08:46 +0100,
Salil Mehta <salil.mehta@huawei.com> wrote:
> 
> Hi Marc,
> 
> > From: Marc Zyngier <maz@kernel.org>
> > Sent: Thursday, May 18, 2023 9:06 AM
> > To: Oliver Upton <oliver.upton@linux.dev>
> > Cc: Salil Mehta <salil.mehta@huawei.com>; kvmarm@lists.linux.dev;
> > kvm@vger.kernel.org; Paolo Bonzini <pbonzini@redhat.com>; James Morse
> > <james.morse@arm.com>; Suzuki K Poulose <suzuki.poulose@arm.com>; yuzenghui
> > <yuzenghui@huawei.com>; Sean Christopherson <seanjc@google.com>
> > Subject: Re: [PATCH v3 08/13] KVM: arm64: Add support for
> > KVM_EXIT_HYPERCALL
> > 
> > On Wed, 17 May 2023 19:38:14 +0100,
> > Oliver Upton <oliver.upton@linux.dev> wrote:
> > >
> > > Hi Salil,
> > >
> > > On Wed, May 17, 2023 at 06:00:18PM +0000, Salil Mehta wrote:
> > >
> > > [...]
> > >
> > > > > > Should we expose the ESR, or at least ESR_EL2.IL as an additional
> > > > > > flag?
> > > >
> > > >
> > > > I think we would need "Immediate value" of the ESR_EL2 register in the
> > > > user-space/VMM to be able to construct the syndrome value. I cannot see
> > > > where it is being sent?
> > >
> > > The immediate value is not exposed to userspace, although by definition
> > > the immediate value must be zero. The SMCCC spec requires all compliant
> > > calls to use an immediate of zero (DEN0028E 2.9).
> > >
> > > Is there a legitimate use case for hypercalls with a nonzero immediate?
> > > They would no longer be considered SMCCC calls at that point, so they
> > > wouldn't work with the new UAPI.
> > 
> > I agree. The use of non-zero immediate has long been deprecated. I
> > guess we should actually reject non-zero immediate for HVC just like
> > we do for SMC.
> 
> 
> Ok. Maybe I will hard code Immediate value as 0 to create a syndrome value
> at the VMM/Qemu and will also put a note stating non-zero immediate for
> HVC/SVC are not supported/deprecated.

Yes, because this should be the only situation where you should see
such an exit to userspace.

> > If there is an actual need for a non-zero immediate to be propagated
> > to userspace (want to emulate Xen's infamous 'HVC #0xEA1'?), then this
> > should be an extension to the current API.
> 
> Oh ok, then perhaps this new extension change should be simultaneously
> committed to avoid breaking Xen?

How would that break Xen? I don't have any plan to emulate Xen in any
shape or form, and I don't think anyone want to do that in userspace
either.

I really want to see an actual use case to expand this stuff. Because
so far, we follow the strict SMCCC spec, and nothing else. But if we
admit deviations, do we also have to expose SMC and HVC as different
instructions?

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.
