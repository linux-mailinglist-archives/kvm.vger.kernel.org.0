Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id C87ED48C342
	for <lists+kvm@lfdr.de>; Wed, 12 Jan 2022 12:37:18 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1352893AbiALLhR (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Wed, 12 Jan 2022 06:37:17 -0500
Received: from dfw.source.kernel.org ([139.178.84.217]:54236 "EHLO
        dfw.source.kernel.org" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239690AbiALLhR (ORCPT <rfc822;kvm@vger.kernel.org>);
        Wed, 12 Jan 2022 06:37:17 -0500
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id BDBBD61862
        for <kvm@vger.kernel.org>; Wed, 12 Jan 2022 11:37:16 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 16CA5C36AE9;
        Wed, 12 Jan 2022 11:37:16 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1641987436;
        bh=ELGmfdGB+Qa9ZMuMc84rnCgltPOBDTiQTDC3b8/gV/Q=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=ZGy6tcuT7keW17J9J4OG3QInYsviQ9vWvwEVwMJoAwrpD1ruwo9vlm1c3TcwyzqS8
         vvIwPqrXl7MyjDEXqqOdYhnRx7800sGkAFKh5j4X4fKnSTBG44Jmerzh8L+I0V3YYs
         EqaMm6/ojOoY8JlQKSgQN4rZWVpngesHBlHVePlN+q9Z8Ggq2adpknYJI64RtN716m
         Q4XgvygAqpNuqlKG7XfEq+jdO36wf1XIH0F747LFAcx+TAwBFb7YW9v4whC6lcqy+T
         HtvIhXwo1ohSidfzouYZnmmU/GX27/sJhFroOfHkgVNoNOcn97SyI5ef2BT4+MRzUR
         KeWhLw48RMBQA==
Received: from sofa.misterjones.org ([185.219.108.64] helo=why.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1n7bwH-00021I-Dp; Wed, 12 Jan 2022 11:37:13 +0000
Date:   Wed, 12 Jan 2022 11:37:12 +0000
Message-ID: <87sfttrxqv.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Jing Zhang <jingzhangos@google.com>
Cc:     KVM <kvm@vger.kernel.org>, KVMARM <kvmarm@lists.cs.columbia.edu>,
        Will Deacon <will@kernel.org>,
        Paolo Bonzini <pbonzini@redhat.com>,
        David Matlack <dmatlack@google.com>,
        Oliver Upton <oupton@google.com>,
        Reiji Watanabe <reijiw@google.com>,
        Raghavendra Rao Ananta <rananta@google.com>
Subject: Re: [RFC PATCH 3/3] KVM: selftests: Add vgic initialization for dirty log perf test for ARM
In-Reply-To: <CAAdAUthmAMy3UE3_C_CitW9MWWMGcOPHu0x9aV72YEUL2kpO=g@mail.gmail.com>
References: <20220110210441.2074798-1-jingzhangos@google.com>
        <20220110210441.2074798-4-jingzhangos@google.com>
        <87a6g2tvia.wl-maz@kernel.org>
        <CAAdAUthmAMy3UE3_C_CitW9MWWMGcOPHu0x9aV72YEUL2kpO=g@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: jingzhangos@google.com, kvm@vger.kernel.org, kvmarm@lists.cs.columbia.edu, will@kernel.org, pbonzini@redhat.com, dmatlack@google.com, oupton@google.com, reijiw@google.com, rananta@google.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Tue, 11 Jan 2022 22:16:01 +0000,
Jing Zhang <jingzhangos@google.com> wrote:
> 
> On Tue, Jan 11, 2022 at 2:30 AM Marc Zyngier <maz@kernel.org> wrote:
> >
> > On Mon, 10 Jan 2022 21:04:41 +0000,
> > Jing Zhang <jingzhangos@google.com> wrote:
> > >
> > > For ARM64, if no vgic is setup before the dirty log perf test, the
> > > userspace irqchip would be used, which would affect the dirty log perf
> > > test result.
> >
> > Doesn't it affect *all* performance tests? How much does this change
> > contributes to the performance numbers you give in the cover letter?
> >
> This bottleneck showed up after adding the fast path patch. I didn't
> try other performance tests with this, but I think it is a good idea
> to add a vgic setup for all performance tests. I can post another
> patch later to make it available for all performance tests after
> finishing this one and verifying all other performance tests.
> Below is the test result without adding the vgic setup. It shows
> 20~30% improvement for the different number of vCPUs.
> +-------+------------------------+
>     | #vCPU | dirty memory time (ms) |
>     +-------+------------------------+
>     | 1     | 965                    |
>     +-------+------------------------+
>     | 2     | 1006                    |
>     +-------+------------------------+
>     | 4     | 1128                    |
>     +-------+------------------------+
>     | 8     | 2005                   |
>     +-------+------------------------+
>     | 16    | 3903                   |
>     +-------+------------------------+
>     | 32    | 7595                   |
>     +-------+------------------------+
>     | 64    | 15783                  |
>     +-------+------------------------+

So please use these numbers in your cover letter when you repost your
series, as the improvement you'd observe on actual workloads is likely
to be less than what you claim due to this change in the test itself
(in other words, if you are going to benchamark something, don't
change the benchmark halfway).

	M.

-- 
Without deviation from the norm, progress is not possible.
