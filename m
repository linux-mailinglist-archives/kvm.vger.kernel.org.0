Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 8C5F447A69E
	for <lists+kvm@lfdr.de>; Mon, 20 Dec 2021 10:10:45 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230036AbhLTJKo (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Mon, 20 Dec 2021 04:10:44 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:40408 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229474AbhLTJKn (ORCPT <rfc822;kvm@vger.kernel.org>);
        Mon, 20 Dec 2021 04:10:43 -0500
Received: from ams.source.kernel.org (ams.source.kernel.org [IPv6:2604:1380:4601:e00::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 6C1A0C061574
        for <kvm@vger.kernel.org>; Mon, 20 Dec 2021 01:10:43 -0800 (PST)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by ams.source.kernel.org (Postfix) with ESMTPS id 34480B801B8
        for <kvm@vger.kernel.org>; Mon, 20 Dec 2021 09:10:42 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id CA1F2C36AE8;
        Mon, 20 Dec 2021 09:10:40 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1639991440;
        bh=EJumnoaZeL0MRLglZLFSP0eOcfo9r/+3WUIOJDJ1E4A=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=qCePg3LrYhG8im9BNU0aClXtAXDhqvEBxQusPxr97oE0DEpZdrhR3bzBFbg8Lu56G
         yT1/RAnHyex6sbpIwMzq85AbNpv7Jc9/T7+HNYDCEKA9HWEDfaVsLqMAFHSX1Hyulp
         7ZX2NuNkwo5wyAHLdMHaZtePlPm+ibE0Su82X+2O/+E9Jnjtm/OoTRcv/7IQ8ilb1c
         FvEyvjPy7p3sVHo4l7CtvxwFMFoZpynyUyFtYgXNSKHw7unDmUzyChxlM0PFVXSq1/
         lsXDEZ7H9bghrbLirFPesSHYVcZ1cOiR+8jjHBRwaIHFbi89gP5Idh7uiqed1gMLBQ
         XOy92uisLw/SA==
Received: from cfbb000407.r.cam.camfibre.uk ([185.219.108.64] helo=why.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1mzEgo-00DFGF-Qz; Mon, 20 Dec 2021 09:10:38 +0000
Date:   Mon, 20 Dec 2021 09:10:38 +0000
Message-ID: <87lf0fwsj5.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Ganapatrao Kulkarni <gankulkarni@os.amperecomputing.com>
Cc:     linux-arm-kernel@lists.infradead.org, kvmarm@lists.cs.columbia.edu,
        kvm@vger.kernel.org, Andre Przywara <andre.przywara@arm.com>,
        Christoffer Dall <christoffer.dall@arm.com>,
        Jintack Lim <jintack@cs.columbia.edu>,
        Haibo Xu <haibo.xu@linaro.org>,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Alexandru Elisei <alexandru.elisei@arm.com>,
        kernel-team@android.com
Subject: Re: [PATCH v5 18/69] KVM: arm64: nv: Handle virtual EL2 registers in vcpu_read/write_sys_reg()
In-Reply-To: <13046e57-b7e5-7f0b-15bd-38c09e21807a@os.amperecomputing.com>
References: <20211129200150.351436-1-maz@kernel.org>
        <20211129200150.351436-19-maz@kernel.org>
        <13046e57-b7e5-7f0b-15bd-38c09e21807a@os.amperecomputing.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: gankulkarni@os.amperecomputing.com, linux-arm-kernel@lists.infradead.org, kvmarm@lists.cs.columbia.edu, kvm@vger.kernel.org, andre.przywara@arm.com, christoffer.dall@arm.com, jintack@cs.columbia.edu, haibo.xu@linaro.org, james.morse@arm.com, suzuki.poulose@arm.com, alexandru.elisei@arm.com, kernel-team@android.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Mon, 20 Dec 2021 07:04:44 +0000,
Ganapatrao Kulkarni <gankulkarni@os.amperecomputing.com> wrote:
> 
> 
> On 30-11-2021 01:30 am, Marc Zyngier wrote:
> > KVM internally uses accessor functions when reading or writing the
> > guest's system registers. This takes care of accessing either the stored
> > copy or using the "live" EL1 system registers when the host uses VHE.
> > 
> > With the introduction of virtual EL2 we add a bunch of EL2 system
> > registers, which now must also be taken care of:
> > - If the guest is running in vEL2, and we access an EL1 sysreg, we must
> >    revert to the stored version of that, and not use the CPU's copy.
> > - If the guest is running in vEL1, and we access an EL2 sysreg, we must
> 
> Do we have vEL1? or is it a typo?

Not a typo, but only a convention (there is no such concept in the
architecture). vELx denotes the exception level the guest thinks it is
running at while running at EL1 (as it is the case for both vEL1 and
vEL2).

Depending on the exception level and the running mode (VHE or not) you
emulate at any given time, you access the sysregs differently: they
can be either live in the CPU, stored in memory, with or without
translation. That's why I'm using these 'parallel' exception levels to
denote which is which...

HTH,

	M.

-- 
Without deviation from the norm, progress is not possible.
