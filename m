Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 0A98F682DA8
	for <lists+kvm@lfdr.de>; Tue, 31 Jan 2023 14:21:42 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230224AbjAaNVk (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Tue, 31 Jan 2023 08:21:40 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59270 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S231872AbjAaNVU (ORCPT <rfc822;kvm@vger.kernel.org>);
        Tue, 31 Jan 2023 08:21:20 -0500
Received: from dfw.source.kernel.org (dfw.source.kernel.org [139.178.84.217])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 102C8B1
        for <kvm@vger.kernel.org>; Tue, 31 Jan 2023 05:21:18 -0800 (PST)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id 9F4EA61504
        for <kvm@vger.kernel.org>; Tue, 31 Jan 2023 13:21:17 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 058D7C433EF;
        Tue, 31 Jan 2023 13:21:17 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1675171277;
        bh=ZHMJN0b9ClADyyKEIl5sAXyp+mv1Bh3OoMA4yF1FxxY=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=DLSR7//V6XsPmJEYe3MvY4c5++Dx5LFTWabMZZBLnZe238Yhjjija8eS6CKosnty3
         23aiu0/7eFPwTVw3v+SZS5s696x98iuNemwQrkjwxSXSVhiirMwXLP4EjDZ8CJmogj
         e++EqtpzOXEcd9dc5RSZ13JDoJnfHdczDr0AmothShXrjDodYF/IZ5kOOht5YQqdph
         AnF4zeiCNr04+Ma6cDJmNxOGgAJNT+pQUTVWJzDWZGlP21eYTQYurs6hToXBHpMk34
         ciWpZ+Z31gHtirFAfNqowFWxLsOHFAVpiPVas25EQcamZ1fbeJmmOElkwOgj2L27ne
         a3A91v1NsyP1g==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.95)
        (envelope-from <maz@kernel.org>)
        id 1pMqZW-006CoO-KL;
        Tue, 31 Jan 2023 13:21:14 +0000
Date:   Tue, 31 Jan 2023 13:21:14 +0000
Message-ID: <86edra262d.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Catalin Marinas <catalin.marinas@arm.com>
Cc:     kvmarm@lists.linux.dev, kvm@vger.kernel.org,
        linux-arm-kernel@lists.infradead.org,
        Alexandru Elisei <alexandru.elisei@arm.com>,
        Andre Przywara <andre.przywara@arm.com>,
        Chase Conklin <chase.conklin@arm.com>,
        Christoffer Dall <christoffer.dall@arm.com>,
        Ganapatrao Kulkarni <gankulkarni@os.amperecomputing.com>,
        Jintack Lim <jintack@cs.columbia.edu>,
        Russell King <rmk+kernel@armlinux.org.uk>,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Oliver Upton <oliver.upton@linux.dev>,
        Zenghui Yu <yuzenghui@huawei.com>
Subject: Re: [PATCH v8 01/69] arm64: Add ARM64_HAS_NESTED_VIRT cpufeature
In-Reply-To: <Y9kDqLqAwm9BR45J@arm.com>
References: <20230131092504.2880505-1-maz@kernel.org>
        <20230131092504.2880505-2-maz@kernel.org>
        <Y9kDqLqAwm9BR45J@arm.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/28.2
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: catalin.marinas@arm.com, kvmarm@lists.linux.dev, kvm@vger.kernel.org, linux-arm-kernel@lists.infradead.org, alexandru.elisei@arm.com, andre.przywara@arm.com, chase.conklin@arm.com, christoffer.dall@arm.com, gankulkarni@os.amperecomputing.com, jintack@cs.columbia.edu, rmk+kernel@armlinux.org.uk, james.morse@arm.com, suzuki.poulose@arm.com, oliver.upton@linux.dev, yuzenghui@huawei.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-7.1 required=5.0 tests=BAYES_00,DKIMWL_WL_HIGH,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,
        SPF_HELO_NONE,SPF_PASS autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Tue, 31 Jan 2023 12:03:52 +0000,
Catalin Marinas <catalin.marinas@arm.com> wrote:
> 
> On Tue, Jan 31, 2023 at 09:23:56AM +0000, Marc Zyngier wrote:
> > diff --git a/Documentation/admin-guide/kernel-parameters.txt b/Documentation/admin-guide/kernel-parameters.txt
> > index 6cfa6e3996cf..b7b0704e360e 100644
> > --- a/Documentation/admin-guide/kernel-parameters.txt
> > +++ b/Documentation/admin-guide/kernel-parameters.txt
> > @@ -2553,9 +2553,14 @@
> >  			protected: nVHE-based mode with support for guests whose
> >  				   state is kept private from the host.
> >  
> > +			nested: VHE-based mode with support for nested
> > +				virtualization. Requires at least ARMv8.3
> > +				hardware.
> 
> So we can't have protected + nested at the same time? ;) (I guess once
> you make the protected mode use VHE, this could be revisited)

We could move the whole shadow S2 inside the protected hypervisor, but
that's pretty complicated, as this mandates multiple S2 contexts per
VMs. I'd really want to see a use case for it before I even try.

On the other hand, debugging the protected hypervisor (or at least its
VHE version) under NV is pretty fun. Makes the whole debug cycle
incredibly short.

> In the hope that this averts another post of the series:
> 
> Acked-by: Catalin Marinas <catalin.marinas@arm.com>

Thanks! But I'm afraid you'll definitely see more of this stuff. I can
only hope it gets merge quicker than I add to it...

	M.

-- 
Without deviation from the norm, progress is not possible.
