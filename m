Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 9D3C56D00B0
	for <lists+kvm@lfdr.de>; Thu, 30 Mar 2023 12:10:06 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230374AbjC3KKE (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Thu, 30 Mar 2023 06:10:04 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:49972 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229680AbjC3KKC (ORCPT <rfc822;kvm@vger.kernel.org>);
        Thu, 30 Mar 2023 06:10:02 -0400
Received: from dfw.source.kernel.org (dfw.source.kernel.org [139.178.84.217])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id 1793D869F
        for <kvm@vger.kernel.org>; Thu, 30 Mar 2023 03:09:39 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id 9A4B861FC6
        for <kvm@vger.kernel.org>; Thu, 30 Mar 2023 10:09:38 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id F2025C433EF;
        Thu, 30 Mar 2023 10:09:37 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1680170978;
        bh=LfP+Xf7RvTzu+2HSBezTLlX0xO4X6/y5lCmGsEkEsrk=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=f2aoxOt0RJ3sNSluSGgUwleIWL8eQ6qyHY+WxZJLvEPqxNOQpTwESkO8NrMzWCmHr
         l3Qz7znYe+oDYLfccvN8hOqWytkW7NwlAK6gIiEM5VBzA+CgURqObN4EeHtlTDQk4r
         qVLmzVD85hsFJD24nM5tFr5YKYGzGos9ipQLrrsnFdf2yOtIWkuQINv9YX2enHxhmt
         lWGxHXT+4UKSSsSjNc923e/Wat+WmGm7vyWQheBbo0//hFK6pdKAk4KKsmwFuGPnfh
         X+y7wvn0n6iJ7cNcAAJQZ+CezmMQzGD83VAGz5fpAslIo12nqrVbqqVhUnYWO2Nfup
         BYUY8AM5OUpjg==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.95)
        (envelope-from <maz@kernel.org>)
        id 1phpDr-004KD1-RP;
        Thu, 30 Mar 2023 11:09:36 +0100
Date:   Thu, 30 Mar 2023 11:09:35 +0100
Message-ID: <86h6u2wnxc.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Oliver Upton <oliver.upton@linux.dev>
Cc:     kvmarm@lists.linux.dev, kvm@vger.kernel.org,
        linux-arm-kernel@lists.infradead.org,
        James Morse <james.morse@arm.com>,
        Suzuki K Poulose <suzuki.poulose@arm.com>,
        Zenghui Yu <yuzenghui@huawei.com>,
        Ricardo Koller <ricarkol@google.com>,
        Simon Veith <sveith@amazon.de>,
        Reiji Watanabe <reijiw@google.com>,
        Colton Lewis <coltonlewis@google.com>,
        Joey Gouly <joey.gouly@arm.com>, dwmw2@infradead.org
Subject: Re: [PATCH v3 05/18] KVM: arm64: timers: Allow physical offset without CNTPOFF_EL2
In-Reply-To: <ZCUvZ9yhfRSKRb3n@linux.dev>
References: <20230324144704.4193635-1-maz@kernel.org>
        <20230324144704.4193635-6-maz@kernel.org>
        <ZCUvZ9yhfRSKRb3n@linux.dev>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/28.2
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: oliver.upton@linux.dev, kvmarm@lists.linux.dev, kvm@vger.kernel.org, linux-arm-kernel@lists.infradead.org, james.morse@arm.com, suzuki.poulose@arm.com, yuzenghui@huawei.com, ricarkol@google.com, sveith@amazon.de, reijiw@google.com, coltonlewis@google.com, joey.gouly@arm.com, dwmw2@infradead.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-5.2 required=5.0 tests=DKIMWL_WL_HIGH,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,SPF_HELO_NONE,
        SPF_PASS autolearn=unavailable autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Thu, 30 Mar 2023 07:42:47 +0100,
Oliver Upton <oliver.upton@linux.dev> wrote:
> 
> Hey Marc,
> 
> On Fri, Mar 24, 2023 at 02:46:51PM +0000, Marc Zyngier wrote:
> > CNTPOFF_EL2 is awesome, but it is mostly vapourware, and no publicly
> > available implementation has it. So for the common mortals, let's
> > implement the emulated version of this thing.
> > 
> > It means trapping accesses to the physical counter and timer, and
> > emulate some of it as necessary.
> > 
> > As for CNTPOFF_EL2, nobody sets the offset yet.
> 
> Did you consider implementing a 'fast' exit handler for counter reads?
> When I took a stab at this a long time ago I had something similar [*].
> Since physical counter emulation is going to effectively be used by all
> systems out there right now it might be worth giving the best emulation
> implementation we can.

Indeed, I have some of that in the NV code, which needs to be
augmented. I'm not sure any guest deeply cares about the physical
counter outside of NV, but I'm happy to hack something together if
someone screams loudly enough!

Thanks,

	M.


-- 
Without deviation from the norm, progress is not possible.
