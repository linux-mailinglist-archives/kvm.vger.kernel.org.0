Return-Path: <kvm+bounces-28886-lists+kvm=lfdr.de@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from am.mirrors.kernel.org (am.mirrors.kernel.org [147.75.80.249])
	by mail.lfdr.de (Postfix) with ESMTPS id 8987699E9F8
	for <lists+kvm@lfdr.de>; Tue, 15 Oct 2024 14:37:14 +0200 (CEST)
Received: from smtp.subspace.kernel.org (wormhole.subspace.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by am.mirrors.kernel.org (Postfix) with ESMTPS id 1697F1F22FCB
	for <lists+kvm@lfdr.de>; Tue, 15 Oct 2024 12:37:14 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 4E8C520B1F9;
	Tue, 15 Oct 2024 12:37:03 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="UYhWLkIR"
X-Original-To: kvm@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 717AE1F941C;
	Tue, 15 Oct 2024 12:37:02 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1728995822; cv=none; b=sn6BdzPY8vgiOIoJKLLLEJmbHinGVs6JcAxD/6u6MhYcjDDQi74zMHT5K/7dB6IYm/YvDHmNAwMlT0i1s2wESXkW34dZgosDYuycZW3rmYz84BjaWGDT9ypBne5/+LDoRax28FUilyrOqU7Hv7s1bC2KqFzTy0Oeg3UBJXUtop4=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1728995822; c=relaxed/simple;
	bh=3xY3hfcRWr6Ylg7ojVLDvQmHojwLA7BHcTJWc1fwP2w=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=UX1T5SG5Uz0tKJ2LEhJSvbr8hxTVDJcdyXQneO4swC/OLQ2tQmS435ym790C5HB6oQEfV/TtgMnWTT04s7t5aPwZdiryT7Qoliwayl/61nKT+lGdYKdEXbWwWtzBwqByfyiAa4AlUe7GxPG00CQlZCwqDjJXczC9aXasGw7gfq4=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=UYhWLkIR; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 06B9BC4CEC6;
	Tue, 15 Oct 2024 12:37:02 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1728995822;
	bh=3xY3hfcRWr6Ylg7ojVLDvQmHojwLA7BHcTJWc1fwP2w=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=UYhWLkIRdJ/jMJ38Sja9hZVy0vFI1xYl7QgS3djQO4j1hYlbYNMr1GXoqpNEFUiQA
	 DIHdTOCUJFOd/xGZbjtAhVrheZFXTRnBzj0Wgk2d/Ef6W4lmsjsuokxJREGOs5p+wW
	 qhu/bGrdsXITi+U4DzxBhX8dgFbtWi7PeAIxbHgwHN+zf3XhGhaQkN3d+a9PY+HtaV
	 hhyhYsBTkh2J1hLsgzjovPPbTKnv2yrwDzoj8/3mIorPJHuf6BRF5+GuGQAWuJxaOn
	 3e2At4/mQJ+EjiqHDxzp3DWFdzrafzyw0/q3dCHIr8jeKwdkBFwlb8fke/B/SxzSHI
	 28tsCOxBRJgCA==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1t0gnL-003iTc-Av;
	Tue, 15 Oct 2024 13:36:59 +0100
Date: Tue, 15 Oct 2024 13:36:58 +0100
Message-ID: <8634kx5yqd.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Ankur Arora <ankur.a.arora@oracle.com>
Cc: linux-pm@vger.kernel.org,
	kvm@vger.kernel.org,
	linux-arm-kernel@lists.infradead.org,
	linux-kernel@vger.kernel.org,
	catalin.marinas@arm.com,
	will@kernel.org,
	tglx@linutronix.de,
	mingo@redhat.com,
	bp@alien8.de,
	dave.hansen@linux.intel.com,
	x86@kernel.org,
	hpa@zytor.com,
	pbonzini@redhat.com,
	wanpengli@tencent.com,
	vkuznets@redhat.com,
	rafael@kernel.org,
	daniel.lezcano@linaro.org,
	peterz@infradead.org,
	arnd@arndb.de,
	lenb@kernel.org,
	mark.rutland@arm.com,
	harisokn@amazon.com,
	mtosatti@redhat.com,
	sudeep.holla@arm.com,
	cl@gentwo.org,
	misono.tomohiro@fujitsu.com,
	maobibo@loongson.cn,
	joao.m.martins@oracle.com,
	boris.ostrovsky@oracle.com,
	konrad.wilk@oracle.com
Subject: Re: [PATCH v8 00/11] Enable haltpoll on arm64
In-Reply-To: <20240925232425.2763385-1-ankur.a.arora@oracle.com>
References: <20240925232425.2763385-1-ankur.a.arora@oracle.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: kvm@vger.kernel.org
List-Id: <kvm.vger.kernel.org>
List-Subscribe: <mailto:kvm+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:kvm+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: ankur.a.arora@oracle.com, linux-pm@vger.kernel.org, kvm@vger.kernel.org, linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org, catalin.marinas@arm.com, will@kernel.org, tglx@linutronix.de, mingo@redhat.com, bp@alien8.de, dave.hansen@linux.intel.com, x86@kernel.org, hpa@zytor.com, pbonzini@redhat.com, wanpengli@tencent.com, vkuznets@redhat.com, rafael@kernel.org, daniel.lezcano@linaro.org, peterz@infradead.org, arnd@arndb.de, lenb@kernel.org, mark.rutland@arm.com, harisokn@amazon.com, mtosatti@redhat.com, sudeep.holla@arm.com, cl@gentwo.org, misono.tomohiro@fujitsu.com, maobibo@loongson.cn, joao.m.martins@oracle.com, boris.ostrovsky@oracle.com, konrad.wilk@oracle.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Thu, 26 Sep 2024 00:24:14 +0100,
Ankur Arora <ankur.a.arora@oracle.com> wrote:
> 
> This patchset enables the cpuidle-haltpoll driver and its namesake
> governor on arm64. This is specifically interesting for KVM guests by
> reducing IPC latencies.
> 
> Comparing idle switching latencies on an arm64 KVM guest with 
> perf bench sched pipe:
> 
>                                      usecs/op       %stdev   
> 
>   no haltpoll (baseline)               13.48       +-  5.19%
>   with haltpoll                         6.84       +- 22.07%
> 
> 
> No change in performance for a similar test on x86:
> 
>                                      usecs/op        %stdev   
> 
>   haltpoll w/ cpu_relax() (baseline)     4.75      +-  1.76%
>   haltpoll w/ smp_cond_load_relaxed()    4.78      +-  2.31%
> 
> Both sets of tests were on otherwise idle systems with guest VCPUs
> pinned to specific PCPUs. One reason for the higher stdev on arm64
> is that trapping of the WFE instruction by the host KVM is contingent
> on the number of tasks on the runqueue.

Sorry to state the obvious, but if that's the variable trapping of
WFI/WFE is the cause of your trouble, why don't you simply turn it off
(see 0b5afe05377d for the details)? Given that you pin your vcpus to
physical CPUs, there is no need for any trapping.

	M.

-- 
Without deviation from the norm, progress is not possible.

