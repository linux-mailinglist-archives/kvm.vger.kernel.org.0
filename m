Return-Path: <kvm+bounces-59097-lists+kvm=lfdr.de@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from am.mirrors.kernel.org (am.mirrors.kernel.org [IPv6:2604:1380:4601:e00::3])
	by mail.lfdr.de (Postfix) with ESMTPS id E0B55BABE04
	for <lists+kvm@lfdr.de>; Tue, 30 Sep 2025 09:44:37 +0200 (CEST)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by am.mirrors.kernel.org (Postfix) with ESMTPS id DF84D1926120
	for <lists+kvm@lfdr.de>; Tue, 30 Sep 2025 07:44:59 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 86FFA219303;
	Tue, 30 Sep 2025 07:44:28 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="I+qJ5cUP"
X-Original-To: kvm@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9154D29E116;
	Tue, 30 Sep 2025 07:44:27 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1759218267; cv=none; b=M6LO83tcoyyPuPU6svoVpF7q3jsjwA4iIsdaMroVPFJp4mM1/gby1yPQjQiA12JjGqSR6xr/2Qkwx/GXWOF3btdcb88rakUPEmL31PcDbuPtRGw3wOOp6AgSHScjKP5elFmk3VjD5VgAUE28G8oaINWC8JXhZ5B3tVnsvYju7Lo=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1759218267; c=relaxed/simple;
	bh=8/Vy0IpBdnBl3FqITdTg6fXAw6N3XdQbwsG+l9Eo8mQ=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=kAnUTwWjJndzhTQC1mHg0MD9Kmq+aJE57FITqVFj8v8kQFKVy3vuj/xmq9ZkYhztRh6yTmPnFJa76J2TNRU1QInjhMv02wzI1vyes8Hwgj83ieRaUOwWJ7lNSQ4Ixyepw3Ve0idL0Bvt2peXEVsjkb27SEN+r6OKCyQaIIgl92g=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=I+qJ5cUP; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 1F3D3C4CEF0;
	Tue, 30 Sep 2025 07:44:27 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1759218267;
	bh=8/Vy0IpBdnBl3FqITdTg6fXAw6N3XdQbwsG+l9Eo8mQ=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=I+qJ5cUPYt9zuzbo3fVNhdOCGiIJeWqXPLm8P121Hi3fEM4gLQ9Uc4HUM9JggJZrJ
	 AOYTlWZz/qprgsasmnH+PE4GGRDc7oioJ1laPXjGKuNUA21CyawfZ7azyZzdZ/CPNj
	 H3dXhezGRebrLbcYm1HwChXGdMChBxPnwrlKMHQgRhwXZeupXYPMW4VXmolt5EjEqN
	 C5BTIwItLLankmAr4YDD4GqCza9i2kdgbCStkM7/qCprmprAN9UdO9hv2MWieNYp1J
	 bSP5fXqYEpTtKaBMMfUAH34bz40isnMzCtPOmQ7gZny/vM0eDvHjLdU8tuX1QkQ9Tb
	 DlvuhrHU+XQ3w==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.98.2)
	(envelope-from <maz@kernel.org>)
	id 1v3V28-0000000ASrQ-2v5h;
	Tue, 30 Sep 2025 07:44:24 +0000
Date: Tue, 30 Sep 2025 08:44:24 +0100
Message-ID: <86zfacz8o7.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Oliver Upton <oliver.upton@linux.dev>
Cc: kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	kvm@vger.kernel.org,
	Joey Gouly <joey.gouly@arm.com>,
	Suzuki K Poulose <suzuki.poulose@arm.com>,
	Zenghui Yu <yuzenghui@huawei.com>
Subject: Re: [PATCH 01/13] KVM: arm64: Hide CNTHV_*_EL2 from userspace for nVHE guests
In-Reply-To: <aNslu47Dl13iNcaL@linux.dev>
References: <20250929160458.3351788-1-maz@kernel.org>
	<20250929160458.3351788-2-maz@kernel.org>
	<aNslu47Dl13iNcaL@linux.dev>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/30.1
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: kvm@vger.kernel.org
List-Id: <kvm.vger.kernel.org>
List-Subscribe: <mailto:kvm+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:kvm+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: oliver.upton@linux.dev, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, kvm@vger.kernel.org, joey.gouly@arm.com, suzuki.poulose@arm.com, yuzenghui@huawei.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Tue, 30 Sep 2025 01:35:07 +0100,
Oliver Upton <oliver.upton@linux.dev> wrote:
> 
> Hey,
> 
> On Mon, Sep 29, 2025 at 05:04:45PM +0100, Marc Zyngier wrote:
> > Although we correctly UNDEF any CNTHV_*_EL2 access from the guest
> > when E2H==0, we still expose these registers to userspace, which
> > is a bad idea.
> > 
> > Drop the ad-hoc UNDEF injection and switch to a .visibility()
> > callback which will also hide the register from userspace.
> > 
> > Fixes: 0e45981028550 ("KVM: arm64: timer: Don't adjust the EL2 virtual timer offset")
> > Signed-off-by: Marc Zyngier <maz@kernel.org>
> > ---
> >  arch/arm64/kvm/sys_regs.c | 26 +++++++++++++-------------
> >  1 file changed, 13 insertions(+), 13 deletions(-)
> > 
> > diff --git a/arch/arm64/kvm/sys_regs.c b/arch/arm64/kvm/sys_regs.c
> > index ee8a7033c85bf..9f2f4e0b042e8 100644
> > --- a/arch/arm64/kvm/sys_regs.c
> > +++ b/arch/arm64/kvm/sys_regs.c
> > @@ -1594,16 +1594,6 @@ static bool access_arch_timer(struct kvm_vcpu *vcpu,
> >  	return true;
> >  }
> >  
> > -static bool access_hv_timer(struct kvm_vcpu *vcpu,
> > -			    struct sys_reg_params *p,
> > -			    const struct sys_reg_desc *r)
> > -{
> > -	if (!vcpu_el2_e2h_is_set(vcpu))
> > -		return undef_access(vcpu, p, r);
> > -
> > -	return access_arch_timer(vcpu, p, r);
> > -}
> > -
> >  static s64 kvm_arm64_ftr_safe_value(u32 id, const struct arm64_ftr_bits *ftrp,
> >  				    s64 new, s64 cur)
> >  {
> > @@ -2831,6 +2821,16 @@ static unsigned int s1pie_el2_visibility(const struct kvm_vcpu *vcpu,
> >  	return __el2_visibility(vcpu, rd, s1pie_visibility);
> >  }
> >  
> > +static unsigned int cnthv_visibility(const struct kvm_vcpu *vcpu,
> > +				     const struct sys_reg_desc *rd)
> > +{
> > +	if (vcpu_has_nv(vcpu) &&
> > +	    !vcpu_has_feature(vcpu, KVM_ARM_VCPU_HAS_EL2_E2H0))
> > +		return 0;
> > +
> > +	return REG_HIDDEN;
> > +}
> 
> Hmm. We've already exposed these to userspace at this point, we just
> conveniently last the get-reg-list test to assert the accessibility of
> these (broken) exposures.
> 
> Given the amount of UAPI mishaps we've had with registers in the past I
> don't have much appetite for taking away something we already
> advertised.
> 
> What about making these RAZ/WI from userspace?

Honestly, I don't think we should bother.

The only VMM supporting NV is QEMU, and it explicitly isn't able to
select E2H0. I'm happy to Cc stable on this, but worrying about nVHE
save/restore at this stage seems like an overreaction -- I'm pretty
sure NV save/restore is generally broken in many more ways.

Thanks,

	M.

-- 
Without deviation from the norm, progress is not possible.

