Return-Path: <kvm+bounces-33984-lists+kvm=lfdr.de@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from am.mirrors.kernel.org (am.mirrors.kernel.org [147.75.80.249])
	by mail.lfdr.de (Postfix) with ESMTPS id E608F9F54D0
	for <lists+kvm@lfdr.de>; Tue, 17 Dec 2024 18:47:41 +0100 (CET)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by am.mirrors.kernel.org (Postfix) with ESMTPS id DF2D31892184
	for <lists+kvm@lfdr.de>; Tue, 17 Dec 2024 17:44:46 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id F25EE1F8EFF;
	Tue, 17 Dec 2024 17:38:33 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="ntwJA53l"
X-Original-To: kvm@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 22E868615A;
	Tue, 17 Dec 2024 17:38:32 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1734457113; cv=none; b=jlwB97o6JO0lfuwepExGiKvKz3C9prOLiO5YJVc2YT08RoyQsZ1LUvMlDIHzhL70Yx5qGzTzTjEzaZ9Y/6aSWxc/apGVh4r3DMKW9HMdBdGgkXLZY6tAAsjSMfreRUGynriSU8rGNKt71i566pabGQm42oD7HWJgUEE4oEWJl7c=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1734457113; c=relaxed/simple;
	bh=drmIapqZOtyKxi6JCkbBuJFmy/DxlTvVFIXPKTYMk9U=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=loNbSLV1fDZsIaPXOT96/sCdz22dj+vtE6K4Da1rivJO4Z/ya8Ia2ebXbfo4Yg1WU1uy0pfVokm4Oko4iWrNHSwsYEq3hGtf03DEcHBXlIAFJ3LfGY/3Tui9T6CrtiUbezypWq14I8kN7zFCj5f+I0vkJVUKXMpFeROBlhSppSo=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=ntwJA53l; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id BADDEC4CED3;
	Tue, 17 Dec 2024 17:38:32 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1734457112;
	bh=drmIapqZOtyKxi6JCkbBuJFmy/DxlTvVFIXPKTYMk9U=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=ntwJA53lwMeohmy4JIXkA1wKebsYZPaKwX3NKwqqMYygVn5QQ4T4UbkIOi6IR8/1u
	 Djv6ipAsJakD7Fz5GNDF3i+Sxwn//P16A27Wf1pb8TpMpfTyLjQy5RNDj/+qw3zeN/
	 C2Ig3oX3ZVehVEmpkcLrDQqAnquGJUS2FqivaPFz/yZjGEl/m3nSHWjRz3KyE0HBTq
	 drgL4AfqQFrW2XiKCpyoNrvoVKSYGQd4JpxLGHM07or+KXe+1981CLJgRQRQvcE7Hn
	 5dIlvREIx1aVEMXqQP/KlH0XTqNbFVeuRLhmdvk0dzfnyCGpx4g6SHULXVNCHu/3rb
	 v86pckt9T6V4g==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1tNbWg-004eRJ-5C;
	Tue, 17 Dec 2024 17:38:30 +0000
Date: Tue, 17 Dec 2024 17:38:25 +0000
Message-ID: <86ldweqkfi.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	kvm@vger.kernel.org
Cc: Joey Gouly <joey.gouly@arm.com>,
	Suzuki K Poulose <suzuki.poulose@arm.com>,
	Oliver Upton <oliver.upton@linux.dev>,
	Zenghui Yu <yuzenghui@huawei.com>,
	Andre Przywara <andre.przywara@arm.com>,
	Eric Auger <eauger@redhat.com>,
	Ganapatrao Kulkarni <gankulkarni@os.amperecomputing.com>
Subject: Re: [PATCH 11/16] KVM: arm64: nv: Add Maintenance Interrupt emulation
In-Reply-To: <20241217151331.934077-12-maz@kernel.org>
References: <20241217151331.934077-1-maz@kernel.org>
	<20241217151331.934077-12-maz@kernel.org>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: kvm@vger.kernel.org
List-Id: <kvm.vger.kernel.org>
List-Subscribe: <mailto:kvm+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:kvm+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, kvm@vger.kernel.org, joey.gouly@arm.com, suzuki.poulose@arm.com, oliver.upton@linux.dev, yuzenghui@huawei.com, andre.przywara@arm.com, eauger@redhat.com, gankulkarni@os.amperecomputing.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Tue, 17 Dec 2024 15:13:26 +0000,
Marc Zyngier <maz@kernel.org> wrote:
> 
> Emulating the vGIC means emulating the dreaded Maintenance Interrupt.
> 
> This is a two-pronged problem:
> 
> - while running L2, getting an MI translates into an MI injected
>   in the L1 based on the state of the HW.
> 
> - while running L1, we must accurately reflect the state of the
>   MI line, based on the in-memory state.
> 
> The MI INTID is added to the distributor, as expected on any
> virtualisation-capable implementation, and further patches
> will allow its configuration.
> 
> Signed-off-by: Marc Zyngier <maz@kernel.org>
> ---
>  arch/arm64/kvm/arm.c                 |  6 ++++
>  arch/arm64/kvm/vgic/vgic-init.c      | 22 ++++++++++++++
>  arch/arm64/kvm/vgic/vgic-v3-nested.c | 45 ++++++++++++++++++++++++++++
>  arch/arm64/kvm/vgic/vgic.c           |  9 ++++++
>  arch/arm64/kvm/vgic/vgic.h           |  2 ++
>  include/kvm/arm_vgic.h               |  4 +++
>  6 files changed, 88 insertions(+)
> 
> diff --git a/arch/arm64/kvm/arm.c b/arch/arm64/kvm/arm.c
> index 5e353b2c225b4..756cc4e74e10f 100644
> --- a/arch/arm64/kvm/arm.c
> +++ b/arch/arm64/kvm/arm.c
> @@ -824,6 +824,12 @@ int kvm_arch_vcpu_run_pid_change(struct kvm_vcpu *vcpu)
>  	if (ret)
>  		return ret;
>  
> +	if (vcpu_has_nv(vcpu)) {
> +		ret = kvm_vgic_vcpu_nv_init(vcpu);
> +		if (ret)
> +			return ret;
> +	}
> +
>  	/*
>  	 * This needs to happen after any restriction has been applied
>  	 * to the feature set.
> diff --git a/arch/arm64/kvm/vgic/vgic-init.c b/arch/arm64/kvm/vgic/vgic-init.c
> index bc7e22ab5d812..d2724315a70e9 100644
> --- a/arch/arm64/kvm/vgic/vgic-init.c
> +++ b/arch/arm64/kvm/vgic/vgic-init.c
> @@ -180,6 +180,20 @@ static int kvm_vgic_dist_init(struct kvm *kvm, unsigned int nr_spis)
>  	return 0;
>  }
>  
> +int kvm_vgic_vcpu_nv_init(struct kvm_vcpu *vcpu)
> +{
> +	int ret;
> +
> +	guard(mutex)(&vcpu->kvm->arch.config_lock);
> +
> +	/* Cope with vintage userspace. Maybe we should fail instead */
> +	if (vcpu->kvm->arch.vgic.maint_irq == 0)
> +		vcpu->kvm->arch.vgic.maint_irq = kvm_vgic_global_state.maint_irq;

Well, that didn't take too long, and Joey did hit a bug here. Although
the two fields have the same name, they represent something totally
different:

- kvm_vgic_global_state.maint_irq is the interrupt number Linux uses
  for the host. It's just a number, without any signification other
  than for the kernel's own stuff.

- vcpu->kvm->arch.vgic.maint_irq is an GIC INTID. Really not the same
  thing as the above.

What this should read is something like:

diff --git a/arch/arm64/kvm/vgic/vgic-init.c b/arch/arm64/kvm/vgic/vgic-init.c
index d2724315a70e9..8d92b05639588 100644
--- a/arch/arm64/kvm/vgic/vgic-init.c
+++ b/arch/arm64/kvm/vgic/vgic-init.c
@@ -188,7 +188,7 @@ int kvm_vgic_vcpu_nv_init(struct kvm_vcpu *vcpu)
 
 	/* Cope with vintage userspace. Maybe we should fail instead */
 	if (vcpu->kvm->arch.vgic.maint_irq == 0)
-		vcpu->kvm->arch.vgic.maint_irq = kvm_vgic_global_state.maint_irq;
+		vcpu->kvm->arch.vgic.maint_irq = irq_get_irq_data(kvm_vgic_global_state.maint_irq)->hwirq;
 	ret = kvm_vgic_set_owner(vcpu, vcpu->kvm->arch.vgic.maint_irq, vcpu);
 
 	return ret;

So I guess there are two things that need to happen:

- rename vcpu->kvm->arch.vgic.maint_irq to something like "mi_intid"

- make the damn thing fail, as the comment suggests. We don't have any
  legacy worth speaking of anyway.

Another thing is that Joey (who really didn't waste any time finding
issues) pointed out that we happily allow NV without GICv3. Clearly,
this should also be prevented.

Thanks Joey!

	M.

-- 
Without deviation from the norm, progress is not possible.

