Return-Path: <kvm-owner@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 15A35440F2F
	for <lists+kvm@lfdr.de>; Sun, 31 Oct 2021 16:36:14 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229853AbhJaPio (ORCPT <rfc822;lists+kvm@lfdr.de>);
        Sun, 31 Oct 2021 11:38:44 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:36440 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229734AbhJaPin (ORCPT <rfc822;kvm@vger.kernel.org>);
        Sun, 31 Oct 2021 11:38:43 -0400
Received: from mail-ot1-x32a.google.com (mail-ot1-x32a.google.com [IPv6:2607:f8b0:4864:20::32a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id D94F9C061570
        for <kvm@vger.kernel.org>; Sun, 31 Oct 2021 08:36:11 -0700 (PDT)
Received: by mail-ot1-x32a.google.com with SMTP id v19-20020a9d69d3000000b00555a7318f31so9602398oto.9
        for <kvm@vger.kernel.org>; Sun, 31 Oct 2021 08:36:11 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20210112;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=zyaynE2EfZgIjGnuqh23tw4nEncoqsvfeJUvwl7i7Ug=;
        b=RBv+zjSFfYMBSI99yAG/uYZn02QQISN752m+UmLJHXLVYUw7gkj9yaP5335oYvl1Ks
         JaGGn0gYvETTDEdNCA0RQ2yZKTkOhbFP0ZWFwjGQ9TPG7KCp8NRfjW7mcbJrvsXNsSeK
         Zj/K7k45s9mx+85nFDZa2QSLyFi4ecKTFJ2aCUt1aKgeeF4smnjeaMiPZGU4QSVINNHa
         M0dHj2Uli8hLDOB7yLkXSOGHQJUyj2p3+TwEZBgcmSZSlES503Vm2A08geIsTLtil6jk
         F2rHulYvTB+6GB7F8AXCJNI93AT7fjO/5BG/8XXtxEWMWqhIASgrXCgEDzeodOHvmZ6W
         IUjA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=zyaynE2EfZgIjGnuqh23tw4nEncoqsvfeJUvwl7i7Ug=;
        b=rPSYXosvNet8rk+gXm5otktXYloWmIaLD52GWw3Exk12+drihvu7LhhksliLMVODiP
         zEPdd/RjXmjEYQbh1D6+8T3nXiesEmc2UL++ZCdIUxmAebRXXtJFEp6Zjd3MrHKi2S9b
         V3sGPvkON0wiMNQIS2HUnQkx8Y4jPctUTgY0yBoCVZFPijJT/Wk3JKh5KugCzbhG/m4M
         aI2OO9nglfbIq6Sf0wcmPL6hefs77lPsJBOStUMJXlUvwVEU8zDckyIJsJNfYzoUk6NA
         JMoC0V0lhD1rO/OnnD5uZU/Ay5CR3IJVs9ncoYvkYabNtPYG43+RUsoVu4amgXHWvgZ0
         9/nA==
X-Gm-Message-State: AOAM531sxWe0fqu+P53wkW6P56VAo/Je1ok1A5QYqw8yl+Cn6CQnzWSA
        x2W2rbHdZTgyfGqRXNPsmdwMbCFqIj80TuMB4FTNWw==
X-Google-Smtp-Source: ABdhPJxWyoZcoMk9z8Ozd0F29yk/e3pwfWP5yaJ7EwPAmF/hBEH1Xfp0ZrSsPzfbUhIe3020MdnDJAXe2Ie5Vf3dmaM=
X-Received: by 2002:a9d:1c8c:: with SMTP id l12mr17258110ota.35.1635694541082;
 Sun, 31 Oct 2021 08:35:41 -0700 (PDT)
MIME-Version: 1.0
References: <20211031055634.894263-1-zxwang42@gmail.com> <20211031055634.894263-7-zxwang42@gmail.com>
 <969294ed-444b-3806-af2d-b94ed9eded80@redhat.com>
In-Reply-To: <969294ed-444b-3806-af2d-b94ed9eded80@redhat.com>
From:   Marc Orr <marcorr@google.com>
Date:   Sun, 31 Oct 2021 08:35:29 -0700
Message-ID: <CAA03e5EBZ0YYf+nDjHRuaHX=on+u4hph3AFyiSRty6QLkB=Vbw@mail.gmail.com>
Subject: Re: [kvm-unit-tests PATCH v1 6/7] scripts: Generalize EFI check
To:     Paolo Bonzini <pbonzini@redhat.com>
Cc:     Zixuan Wang <zxwang42@gmail.com>, kvm@vger.kernel.org,
        drjones@redhat.com, erdemaktas@google.com, rientjes@google.com,
        seanjc@google.com, brijesh.singh@amd.com, Thomas.Lendacky@amd.com,
        varad.gautam@suse.com, jroedel@suse.de, bp@suse.de
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <kvm.vger.kernel.org>
X-Mailing-List: kvm@vger.kernel.org

On Sun, Oct 31, 2021 at 12:13 AM Paolo Bonzini <pbonzini@redhat.com> wrote:
>
> On 31/10/21 06:56, Zixuan Wang wrote:
> > From: Marc Orr<marcorr@google.com>
> >
> > Previously, the scripts distinguish between seabios and UEFI via a
> > hard-coded env var in the EFI run script, `arch/x86/efi/run`.
> > Furthermore, this var is passed to the x86 run script, `arch/x86/run`,
> > and then not available in other scripts (or to other architectures).
> >
> > Replace the previous approach with a common helper function to check
> > whether the repo has been configured to run under EFI. The helper does
> > this by probing the `config.mak` file generated by `configure`.
>
> It should be possible to just use
>
>         [ "${TARGET_EFI}" == "y" ]
>
> as the test:
>
> diff --git a/x86/efi/run b/x86/efi/run
> index 922b266..aacc691 100755
> --- a/x86/efi/run
> +++ b/x86/efi/run
> @@ -52,7 +52,6 @@ popd || exit 2
>   # run in UEFI, some test cases, e.g. `x86/pmu.c`, require more free memory. A
>   # simple fix is to increase the QEMU default memory size to 256MiB so that
>   # UEFI's largest allocatable memory region is large enough.
> -EFI_RUN=y \
>   "$TEST_DIR/run" \
>         -drive file="$EFI_UEFI",format=raw,if=pflash,readonly=on \
>         -drive file.dir="$EFI_TEST/$EFI_CASE/",file.driver=vvfat,file.rw=on,format=raw,if=virtio \
> diff --git a/x86/run b/x86/run
> index 4eba2b9..0a4dda9 100755
> --- a/x86/run
> +++ b/x86/run
> @@ -39,12 +39,12 @@ fi
>
>   command="${qemu} --no-reboot -nodefaults $pc_testdev -vnc none -serial stdio $pci_testdev"
>   command+=" -machine accel=$ACCEL"
> -if ! [ "$EFI_RUN" ]; then
> +if [ ${TARGET_EFI} != "y" ]; then
>         command+=" -kernel"
>   fi
>   command="$(timeout_cmd) $command"
>
> -if [ "$EFI_RUN" ]; then
> +if [ ${TARGET_EFI} = "y" ]; then
>         # Set ENVIRON_DEFAULT=n to remove '-initrd' flag for QEMU (see
>         # 'scripts/arch-run.bash' for more details). This is because when using
>         # UEFI, the test case binaries are passed to QEMU through the disk
>
> Paolo
>

Agreed. That SGTM.
