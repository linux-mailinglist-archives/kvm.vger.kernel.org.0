Return-Path: <kvm+bounces-26260-lists+kvm=lfdr.de@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [IPv6:2604:1380:45e3:2400::1])
	by mail.lfdr.de (Postfix) with ESMTPS id 7F513973781
	for <lists+kvm@lfdr.de>; Tue, 10 Sep 2024 14:36:33 +0200 (CEST)
Received: from smtp.subspace.kernel.org (wormhole.subspace.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id 391C0284652
	for <lists+kvm@lfdr.de>; Tue, 10 Sep 2024 12:36:32 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id BB5D41917F0;
	Tue, 10 Sep 2024 12:36:26 +0000 (UTC)
X-Original-To: kvm@vger.kernel.org
Received: from mail.loongson.cn (mail.loongson.cn [114.242.206.163])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id D793818C002
	for <kvm@vger.kernel.org>; Tue, 10 Sep 2024 12:36:22 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=114.242.206.163
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1725971786; cv=none; b=idxNHq2SmMjICN+8xfoOteKSfYHp1ndTcp6lh5lRv3hS851UEjGzYF5Pzr6VrIcbQvE/5JxRp/ykllGGprxGShSYy10NnXzOjS/iQNdshD4E+k6XzYmYDzaeKLSWStka6jTU9xZeI+O/fk/fLIq14ltp7m/h7jYlH6BmnWppQKA=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1725971786; c=relaxed/simple;
	bh=w2uP8zww7308Uio5D0Ei/fwd7KNmErIrcTLtohAH7Mg=;
	h=From:To:Cc:Subject:Date:Message-Id:MIME-Version; b=CjOUsayMjRU0GGpWMqN2F0+zPNxVWuKkLebpYnx5syomvFGbK9HZjjhUJ8dP6/4Tm2nVGDoLSAoo1yhdu85hTkrFKSZFY6aQGfEHOMZdooUzKh9bQvTTtWYc5VhXbDH8C7E9X77CorKjygkp57p2JNYMPh6j/t9udMYQAk9TtQ0=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=loongson.cn; spf=pass smtp.mailfrom=loongson.cn; arc=none smtp.client-ip=114.242.206.163
Authentication-Results: smtp.subspace.kernel.org; dmarc=none (p=none dis=none) header.from=loongson.cn
Authentication-Results: smtp.subspace.kernel.org; spf=pass smtp.mailfrom=loongson.cn
Received: from loongson.cn (unknown [10.2.5.185])
	by gateway (Coremail) with SMTP id _____8CxPutFPeBmZLkDAA--.9405S3;
	Tue, 10 Sep 2024 20:36:21 +0800 (CST)
Received: from localhost.localdomain (unknown [10.2.5.185])
	by front2 (Coremail) with SMTP id qciowMBx+cVCPeBmXGoDAA--.15753S2;
	Tue, 10 Sep 2024 20:36:19 +0800 (CST)
From: Xianglai Li <lixianglai@loongson.cn>
To: qemu-devel@nongnu.org
Cc: Paolo Bonzini <pbonzini@redhat.com>,
	Song Gao <gaosong@loongson.cn>,
	Jiaxun Yang <jiaxun.yang@flygoat.com>,
	Huacai Chen <chenhuacai@kernel.org>,
	"Michael S. Tsirkin" <mst@redhat.com>,
	Cornelia Huck <cohuck@redhat.com>,
	kvm@vger.kernel.org,
	Bibo Mao <maobibo@loongson.cn>
Subject: [RFC PATCH V2 0/5] Added Interrupt controller emulation for loongarch kvm
Date: Tue, 10 Sep 2024 20:18:27 +0800
Message-Id: <cover.1725969898.git.lixianglai@loongson.cn>
X-Mailer: git-send-email 2.39.1
Precedence: bulk
X-Mailing-List: kvm@vger.kernel.org
List-Id: <kvm.vger.kernel.org>
List-Subscribe: <mailto:kvm+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:kvm+unsubscribe@vger.kernel.org>
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
X-CM-TRANSID:qciowMBx+cVCPeBmXGoDAA--.15753S2
X-CM-SenderInfo: 5ol0xt5qjotxo6or00hjvr0hdfq/
X-Coremail-Antispam: 1Uk129KBjDUn29KB7ZKAUJUUUUU529EdanIXcx71UUUUU7KY7
	ZEXasCq-sGcSsGvfJ3UbIjqfuFe4nvWSU5nxnvy29KBjDU0xBIdaVrnUUvcSsGvfC2Kfnx
	nUUI43ZEXa7xR_UUUUUUUUU==

Before this, the interrupt controller simulation has been completed
in the user mode program. In order to reduce the loss caused by frequent
switching of the virtual machine monitor from kernel mode to user mode
when the guest accesses the interrupt controller, we add the interrupt
controller simulation in kvm.

In qemu side implementation is simple, just make a new IPI EXTIOI PCH KVM
related several classes, And the interface to access kvm related data is
implemented.

Most of the simulation work of the interrupt controller is done in kvm.
Because KVM the changes have not been the Linux community acceptance,
the patches of this series will have RFC label until KVM patch into the community.

For the implementation of kvm simulation, refer to the following documents.

IPI simulation implementation reference:
https://github.com/loongson/LoongArch-Documentation/tree/main/docs/Loongson-3A5000-usermanual-EN/inter-processor-interrupts-and-communication

EXTIOI simulation implementation reference:
https://github.com/loongson/LoongArch-Documentation/tree/main/docs/Loongson-3A5000-usermanual-EN/io-interrupts/extended-io-interrupts

PCH-PIC simulation implementation reference:
https://github.com/loongson/LoongArch-Documentation/blob/main/docs/Loongson-7A1000-usermanual-EN/interrupt-controller.adoc

For PCH-MSI, we used irqfd mechanism to send the interrupt signal
generated by user state to kernel state and then to EXTIOI without
maintaining PCH-MSI state in kernel state.

You can easily get the code from the link below:
the kernel:
https://github.com/lixianglai/linux
the branch is: interrupt

the qemu:
https://github.com/lixianglai/qemu
the branch is: interrupt

Please note that the code above is regularly updated based on community
reviews.

changelog:
V1->V2
1.Make changes involving header files a separate patch
2.rebase based on the latest qemu code
3.Optimize the kvm ipi class into the ipi common class and the ipi kvm
class.
4.Optimized the interface for kernel reading and writing data on ipi
extioi pch_pic device.

Cc: Paolo Bonzini <pbonzini@redhat.com>
Cc: Song Gao <gaosong@loongson.cn>
Cc: Jiaxun Yang <jiaxun.yang@flygoat.com>
Cc: Huacai Chen <chenhuacai@kernel.org>
Cc: "Michael S. Tsirkin" <mst@redhat.com>
Cc: Cornelia Huck <cohuck@redhat.com>
Cc: kvm@vger.kernel.org
Cc: Bibo Mao <maobibo@loongson.cn>
Cc: Xianglai Li <lixianglai@loongson.cn>

Xianglai Li (5):
  include: Add macro definitions needed for interrupt controller kvm
    emulation
  hw/loongarch: Add KVM IPI device support
  hw/loongarch: Add KVM extioi device support
  hw/loongarch: Add KVM pch pic device support
  hw/loongarch: Add KVM pch msi device support

 hw/intc/Kconfig                       |   9 +
 hw/intc/loongarch_extioi_kvm.c        | 250 ++++++++++++++++++++++++++
 hw/intc/loongarch_ipi_kvm.c           | 128 +++++++++++++
 hw/intc/loongarch_pch_msi.c           |  42 +++--
 hw/intc/loongarch_pch_pic.c           |  40 +++--
 hw/intc/loongarch_pch_pic_kvm.c       | 180 +++++++++++++++++++
 hw/intc/loongson_ipi_common.c         |  28 +++
 hw/intc/meson.build                   |   3 +
 hw/loongarch/Kconfig                  |   3 +
 hw/loongarch/virt.c                   | 138 ++++++++------
 include/hw/intc/loongarch_extioi.h    |  38 +++-
 include/hw/intc/loongarch_ipi.h       |  15 ++
 include/hw/intc/loongarch_pch_pic.h   |  58 +++++-
 include/hw/intc/loongson_ipi.h        |   1 -
 include/hw/intc/loongson_ipi_common.h |   2 +
 include/hw/loongarch/virt.h           |  15 ++
 linux-headers/asm-loongarch/kvm.h     |  18 ++
 linux-headers/linux/kvm.h             |   6 +
 18 files changed, 891 insertions(+), 83 deletions(-)
 create mode 100644 hw/intc/loongarch_extioi_kvm.c
 create mode 100644 hw/intc/loongarch_ipi_kvm.c
 create mode 100644 hw/intc/loongarch_pch_pic_kvm.c

-- 
2.39.1


