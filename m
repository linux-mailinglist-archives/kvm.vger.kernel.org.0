Return-Path: <kvm+bounces-35788-lists+kvm=lfdr.de@vger.kernel.org>
X-Original-To: lists+kvm@lfdr.de
Delivered-To: lists+kvm@lfdr.de
Received: from sv.mirrors.kernel.org (sv.mirrors.kernel.org [139.178.88.99])
	by mail.lfdr.de (Postfix) with ESMTPS id 6C261A152B1
	for <lists+kvm@lfdr.de>; Fri, 17 Jan 2025 16:19:50 +0100 (CET)
Received: from smtp.subspace.kernel.org (relay.kernel.org [52.25.139.140])
	(using TLSv1.2 with cipher ECDHE-ECDSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by sv.mirrors.kernel.org (Postfix) with ESMTPS id E9E6E3AED70
	for <lists+kvm@lfdr.de>; Fri, 17 Jan 2025 15:19:28 +0000 (UTC)
Received: from localhost.localdomain (localhost.localdomain [127.0.0.1])
	by smtp.subspace.kernel.org (Postfix) with ESMTP id 5B41814883F;
	Fri, 17 Jan 2025 15:19:11 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org;
	dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b="PrbVfVri"
X-Original-To: kvm@vger.kernel.org
Received: from smtp.kernel.org (aws-us-west-2-korg-mail-1.web.codeaurora.org [10.30.226.201])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by smtp.subspace.kernel.org (Postfix) with ESMTPS id 9C7AA18B463;
	Fri, 17 Jan 2025 15:19:07 +0000 (UTC)
Authentication-Results: smtp.subspace.kernel.org; arc=none smtp.client-ip=10.30.226.201
ARC-Seal:i=1; a=rsa-sha256; d=subspace.kernel.org; s=arc-20240116;
	t=1737127148; cv=none; b=YUTgOFGs2Zv5MfT+sBUy2y1Grij9DKgHE53EIrfEWlS/ZZJExxg8YIpcJw1J82jqRfEeTUgKUFTg9VBG2bEsS17u8qB9KxkZh80+ylwCws6nW2kkBdzBZzI5DqeE/Pc3/mdtcFkGWX5YRgdOzA8xFAVH/n1aR8KJAjFvNwxVv6o=
ARC-Message-Signature:i=1; a=rsa-sha256; d=subspace.kernel.org;
	s=arc-20240116; t=1737127148; c=relaxed/simple;
	bh=7AOxCMuccgymNntQbj/et0ikbZnJWyXKUNvh4MpAzXs=;
	h=Date:Message-ID:From:To:Cc:Subject:In-Reply-To:References:
	 MIME-Version:Content-Type; b=f8M+NsuC83WnuhDZfLKmSAnlzY6sXUAz/OtlxBhtsKWooJs/QXMNZg9EVntP/gnfIXKAZYmDky7DpPmeoc83Go19n3WhnaPnmrhtmUQ/DCW6JFTP3ZrXQsLtYAgfhNaStOlXGg178p4VXDCRY652Ek2bpBaAbsRwAM+BI7NWCSo=
ARC-Authentication-Results:i=1; smtp.subspace.kernel.org; dkim=pass (2048-bit key) header.d=kernel.org header.i=@kernel.org header.b=PrbVfVri; arc=none smtp.client-ip=10.30.226.201
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 1B979C4CEDD;
	Fri, 17 Jan 2025 15:19:07 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
	s=k20201202; t=1737127147;
	bh=7AOxCMuccgymNntQbj/et0ikbZnJWyXKUNvh4MpAzXs=;
	h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
	b=PrbVfVri3RKrgzY464O7T1XWwlE8GZGBCAUfU0JRBmdgeKCpLpwfZL2VQcT0yd74w
	 RFB+mmtRKK6EkME5FgMT1VP/IR/YH8mJqvA6ZcAaM9swgSUecTay/8uy2OmAGTcW6H
	 x6bUblZbKVWcGelutGq2WhasMb/NpT3kmiGyU3EbIU8UA6ivUOoII52fka3J6vkNlv
	 0BOzCsz0vjpjjZb3SzOBtXAlsR8NX6W8/Pv9kdHnkqzwrVEXYNyFy2sfwwfjb8SK5b
	 6rqE0CsWytuXy9sMzCdEPRhHP3K/Twqn+H09PDUx4VDX0ldNnYKV57h2IRtZInHgfx
	 I7VQFXzY8sADA==
Received: from sofa.misterjones.org ([185.219.108.64] helo=goblin-girl.misterjones.org)
	by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
	(Exim 4.95)
	(envelope-from <maz@kernel.org>)
	id 1tYo7k-00D9zb-Ku;
	Fri, 17 Jan 2025 15:19:04 +0000
Date: Fri, 17 Jan 2025 15:19:03 +0000
Message-ID: <86wmetv57c.wl-maz@kernel.org>
From: Marc Zyngier <maz@kernel.org>
To: Wei-Lin Chang <r09922117@csie.ntu.edu.tw>
Cc: kvmarm@lists.linux.dev,
	linux-arm-kernel@lists.infradead.org,
	kvm@vger.kernel.org,
	Joey Gouly <joey.gouly@arm.com>,
	Suzuki K Poulose <suzuki.poulose@arm.com>,
	Oliver Upton <oliver.upton@linux.dev>,
	Zenghui Yu <yuzenghui@huawei.com>,
	Bjorn Andersson <andersson@kernel.org>,
	Christoffer Dall <christoffer.dall@arm.com>,
	Ganapatrao Kulkarni <gankulkarni@os.amperecomputing.com>,
	Chase Conklin <chase.conklin@arm.com>,
	Eric Auger <eauger@redhat.com>
Subject: Re: [PATCH v2 09/12] KVM: arm64: nv: Propagate CNTHCTL_EL2.EL1NV{P,V}CT bits
In-Reply-To: <qbmqsm3llnpy2t4ig3uyggkapwlbox2wnfu52gksbhcq4vfpqx@dz5bbn3asn5s>
References: <20241217142321.763801-1-maz@kernel.org>
	<20241217142321.763801-10-maz@kernel.org>
	<qbmqsm3llnpy2t4ig3uyggkapwlbox2wnfu52gksbhcq4vfpqx@dz5bbn3asn5s>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/29.4
 (aarch64-unknown-linux-gnu) MULE/6.0 (HANACHIRUSATO)
Precedence: bulk
X-Mailing-List: kvm@vger.kernel.org
List-Id: <kvm.vger.kernel.org>
List-Subscribe: <mailto:kvm+subscribe@vger.kernel.org>
List-Unsubscribe: <mailto:kvm+unsubscribe@vger.kernel.org>
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: r09922117@csie.ntu.edu.tw, kvmarm@lists.linux.dev, linux-arm-kernel@lists.infradead.org, kvm@vger.kernel.org, joey.gouly@arm.com, suzuki.poulose@arm.com, oliver.upton@linux.dev, yuzenghui@huawei.com, andersson@kernel.org, christoffer.dall@arm.com, gankulkarni@os.amperecomputing.com, chase.conklin@arm.com, eauger@redhat.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false

On Mon, 06 Jan 2025 02:33:39 +0000,
Wei-Lin Chang <r09922117@csie.ntu.edu.tw> wrote:
> 
> Hi Marc and other KVM ARM developers,
> 
> I have a question while learning about NV and reading the code:
> 
> On Tue, Dec 17, 2024 at 02:23:17PM +0000, Marc Zyngier wrote:
> > Allow a guest hypervisor to trap accesses to CNT{P,V}CT_EL02 by
> > propagating these trap bits to the host trap configuration.
> > 
> > Signed-off-by: Marc Zyngier <maz@kernel.org>
> > ---
> >  arch/arm64/kvm/arch_timer.c | 7 +++++++
> >  1 file changed, 7 insertions(+)
> > 
> > diff --git a/arch/arm64/kvm/arch_timer.c b/arch/arm64/kvm/arch_timer.c
> > index 6f04f31c0a7f2..e5951e6eaf236 100644
> > --- a/arch/arm64/kvm/arch_timer.c
> > +++ b/arch/arm64/kvm/arch_timer.c
> > @@ -824,6 +824,10 @@ static void timer_set_traps(struct kvm_vcpu *vcpu, struct timer_map *map)
> >  	 * Apply the enable bits that the guest hypervisor has requested for
> >  	 * its own guest. We can only add traps that wouldn't have been set
> >  	 * above.
> > +	 * Implementation choices: we do not support NV when E2H=0 in the
> > +	 * guest, and we don't support configuration where E2H is writable
> > +	 * by the guest (either FEAT_VHE or FEAT_E2H0 is implemented, but
> > +	 * not both). This simplifies the handling of the EL1NV* bits.
> 
> Previously I was not aware that KVM ARM has these constraints on guest's
> view of NV and E2H, so I appreciate this comment very much. However,
> after digging through the code I could not find anywhere where these
> constraints are enforced, for example initially I thought I would find
> ID_AA64MMFR2_EL1_NV being zeroed in limit_nv_id_regs(), or HCR_NV added
> to the res0 mask of HCR_EL2, base on whether FEAT_VHE or FEAT_E2H0 is
> available to the guest. But seems like in these places the code applies
> constraints looking at the host's capabilities, not the guest's.
> Do you mind providing some pointers for me to investigate the code mode?

Where have you looked?

These constraints are enforced in the kvm-arm64/nv-e2h-select
branch[1], which is pulled in the kvm-arm64/nv-next branch[2].

The NV support is split in discrete series in order to make things
easier to review, but you need to have seen them all to somehow
connect the dots.

HTH,

	M.

[1] https://git.kernel.org/pub/scm/linux/kernel/git/maz/arm-platforms.git/log/?h=kvm-arm64/nv-e2h-select
[2] https://git.kernel.org/pub/scm/linux/kernel/git/maz/arm-platforms.git/log/?h=kvm-arm64/nv-next

-- 
Without deviation from the norm, progress is not possible.

